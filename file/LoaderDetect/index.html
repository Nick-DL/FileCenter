<!doctype html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <link rel="stylesheet" href="/css/mdui.min.css"/>
    <title>FileCenter</title>
    
    <style>
      body {background-color: #f1f3f5;}
      .hidden { display: none !important; }
    </style>
    
    <!-- IE8及以下的 polyfills -->
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/json3@3.3.2/lib/json3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es5-shim@4.5.15/es5-shim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es5-shim@4.5.15/es5-sham.min.js"></script>
    <![endif]-->
    
    <!-- =============================================== -->
    <!-- 智能脚本加载器（核心代码）                        -->
    <!-- =============================================== -->
    <script>
    (function() {
        // 检测是否为IE浏览器
        function isIE() {
            // 方法1: 检测 document.documentMode (IE8-11)
            if (document.documentMode) {
                return true;
            }
            
            // 方法2: 检测 ActiveXObject (IE8-10)
            if (window.ActiveXObject !== undefined) {
                return true;
            }
            
            // 方法3: User Agent 检测 (备用)
            var ua = window.navigator.userAgent;
            var msie = ua.indexOf('MSIE ');      // IE 10 或更早
            var trident = ua.indexOf('Trident/'); // IE 11
            
            return (msie > 0 || trident > 0);
        }
        
        // 检测是否支持现代特性
        function supportsModernJS() {
            try {
                // 检测 fetch API
                if (typeof fetch === 'undefined') {
                    return false;
                }
                
                // 检测 Promise
                if (typeof Promise === 'undefined') {
                    return false;
                }
                
                // 检测 const/let (通过 eval)
                eval('const test = 1;');
                
                // 检测箭头函数
                eval('(() => {})();');
                
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // 动态加载脚本
        function loadScript(src, callback) {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = src;
            
            if (callback) {
                if (script.readyState) {
                    // IE
                    script.onreadystatechange = function() {
                        if (script.readyState === 'loaded' || 
                            script.readyState === 'complete') {
                            script.onreadystatechange = null;
                            callback();
                        }
                    };
                } else {
                    // 现代浏览器
                    script.onload = callback;
                }
            }
            
            document.getElementsByTagName('head')[0].appendChild(script);
        }
        
        // 决定加载哪个版本
        var useCompatVersion = isIE() || !supportsModernJS();
        
        // 显示加载信息（调试用）
        console.log('浏览器检测结果:');
        console.log('- 是否IE: ' + isIE());
        console.log('- 支持现代JS: ' + supportsModernJS());
        console.log('- 使用兼容版: ' + useCompatVersion);
        
        // 保存到全局变量供其他脚本使用
        window.FC_USE_COMPAT_VERSION = useCompatVersion;
        
        // 加载对应版本的脚本
        var scriptSuffix = useCompatVersion ? '-ie.js' : '-modern.js';
        
        // 页面加载完成后加载脚本
        if (document.addEventListener) {
            document.addEventListener('DOMContentLoaded', function() {
                loadScripts();
            });
        } else if (document.attachEvent) {
            // IE8
            document.attachEvent('onreadystatechange', function() {
                if (document.readyState === 'complete') {
                    loadScripts();
                }
            });
        }
        
        function loadScripts() {
            // 1. 加载 MDUI
            loadScript('/js/mdui.min.js', function() {
                console.log('MDUI 加载完成');
                
                // 2. 加载 main.js
                var mainScript = useCompatVersion ? 
                    '/js/main-ie.js' : '/js/main-modern.js';
                    
                loadScript(mainScript, function() {
                    console.log('Main 脚本加载完成: ' + mainScript);
                    
                    // 3. 根据页面加载其他脚本
                    loadPageSpecificScripts(useCompatVersion);
                });
            });
        }
        
        // 加载页面特定脚本
        function loadPageSpecificScripts(useCompat) {
            var path = window.location.pathname;
            var suffix = useCompat ? '-ie.js' : '-modern.js';
            
            if (path.indexOf('/file-list') !== -1) {
                loadScript('/js/FileList' + suffix, function() {
                    console.log('FileList 脚本加载完成');
                });
            } else if (path.indexOf('/navigation') !== -1) {
                loadScript('/js/NavList' + suffix, function() {
                    console.log('NavList 脚本加载完成');
                });
            } else if (path.indexOf('/mirror-sites') !== -1) {
                loadScript('/js/MirrorSite' + suffix, function() {
                    console.log('MirrorSite 脚本加载完成');
                });
            }
        }
    })();
    </script>
</head>

<body class="mdui-loaded mdui-theme-layout-auto">
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a href="/" class="mdui-typo-headline" style="font-weight: 500;">FileCenter</a>
        <a href="/" class="mdui-typo-title" style="font-weight: 500;">
            智能脚本加载器
        </a>
        <div class="mdui-toolbar-spacer"></div>
      </div>
    </div>

    <div class="mdui-container">
      <div class="mdui-row">
        <div class="mdui-col-md-6 mdui-col-offset-md-3">
          <p align="center" class="mdui-typo-display-3" style="color: #0A59F7; font-weight: 700;">
            FileCenter
          </p>
          
          <!-- 浏览器信息显示（可选） -->
          <div class="mdui-card mdui-shadow-0" style="padding: 16px;">
            <p id="browserInfo">正在检测浏览器...</p>
          </div>
        </div>
      </div>
    </div>
    
    <script>
    // 显示浏览器信息（调试用，生产环境可删除）
    setTimeout(function() {
        var info = document.getElementById('browserInfo');
        if (info) {
            var msg = '当前使用: ' + 
                (window.FC_USE_COMPAT_VERSION ? 'IE兼容版脚本' : '现代浏览器版脚本');
            if (info.innerText !== undefined) {
                info.innerText = msg;
            } else {
                info.textContent = msg;
            }
        }
    }, 100);
    </script>
</body>
</html>